---
- name: Simplified AWS VM Provisioning
  hosts: ansible1
  gather_facts: false

  vars:
    vm_name: "{{ vm_name }}"
    vm_flavor_raw: "{{ vm_flavor }}"
    cloud_init_raw: "{{ cloud_init }}"

    # Direct AMI IDs for us-east-1 (update as needed)
    os_ami_map:
      ubuntu-22.04: "ami-0c7217cdde317cfec" # Ubuntu 22.04 LTS
      redhat-9: "ami-0b0af3577fe5e3532" # RHEL 9
      # Add more AMIs as needed

  tasks:
    - name: Validate OS selection
      fail:
        msg: "Unsupported OS '{{ vm_os }}'. Valid options: {{ os_ami_map.keys() | list }}"
      when: vm_os not in os_ami_map

    - name: Set instance type
      set_fact:
        vm_flavor: >-
          {% if vm_flavor_raw == 'small' %}t2.small
          {% elif vm_flavor_raw == 'medium' %}t2.medium
          {% elif vm_flavor_raw == 'large' %}t2.large
          {% else %}t2.micro{% endif %}

    - name: Prepare cloud-init
      set_fact:
        cloud_init: "{{ cloud_init_raw | b64encode }}"

    - name: Clone Terraform project
      ansible.builtin.git:
        repo: https://github.com/khalilMaat/cloud-vm-provision.git
        dest: /tmp/cloud-vm-provision
        force: yes

    - name: Run Terraform
      community.general.terraform:
        project_path: "/tmp/cloud-vm-provision/terraform"
        force_init: true
        state: present
        variables:
          vm_name: "{{ vm_name }}"
          vm_flavor: "{{ vm_flavor }}"
          cloud_init: "{{ cloud_init }}"
          ami_id: "{{ os_ami_map[vm_os] }}"
